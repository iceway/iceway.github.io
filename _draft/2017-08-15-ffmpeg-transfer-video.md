---
layout: post
title:  "用ffmpeg处理视频转换"
date: Tue, 15 Aug 2017 23:14:32 +0800
categories: ffmpeg
tags: ffmpeg video encode
---

ffmpeg是一个开源的集多媒体转码、格式转换、合并/分割视频等功能于一身的强大工具，很多GUI视频处理软件，甚至播放器背后都离不开ffmpeg的支持。最近看了些ffmpeg处理H.264编码的视频的文章，觉得收获挺多的，在此记录下ffmpeg处理H.264和Xvid编码的具体用法，以后可能随时用得到。

对于视频文件，现在常见的都是用一种容器（封装格式）封装上一个视频轨，一个或多个音频轨，有些视频文件还会封装一个或多个字幕轨。目前最为流行的封装格式主要是mp4和mkv，当然也有部分使用avi封装以及少量的rm/rmvb，wmv等，但这些都只是一种封装格式，里面的视频和音频的具体编码格式并不唯一。

说道编码格式，音频中的mp3大家早就被大家所熟知，现在还有AAC，AC3及DTS等音频编码格式也是很流行的。而视频的编码格式，rmvb文件使用的real 8/9/10、wmv文件使用的wmv9等目前在网络上流传的很少了，主流的影视作品目前都不再使用这些编码格式，现在最常见到的影视作品一般都是使用H.264（H.264还有一个名字叫做MPEG-4AVC）编码视频轨，当然也有使用divx/xvid编码视频轨的。

一般avi封装的文件大多使用divx/xvid视频编码加mp3/ac3音频编码，而mp4和mkv封装的文件更多使用H.264视频编码加aac/ac3/dts音频编码。

关于封装格式和编码格式的关系，打个比方：要把几张图片打包成一个压缩包，图片文件可以是jpg格式的，也可以是png或者gif格式的，这就是编码格式。可以打包成rar，也可以是zip或者7z等，而这个就是封装格式。所以说封装格式只是把不同的视频源，音频源及可能的字幕源打包在一起，并能正确识别其包含的各种不同内容，而编码格式才是真正压缩、存储视频、音频等多媒体内容的格式。

ffmpeg可以处理很多种封装格式和编码格式，本文主要想记录使用ffmpeg处理H.264视频编码和AAC音频编码的相关知识。下文会提到x264，这是H.264的开源实现，x264说的就是H.264。

## ffmpeg工具用法

ffmpeg是一个命令行工具包，包含一系列工具，常用的有：

- ffmpeg转码视频
- ffprobe查看视频文件详细的编码及封装信息
- ffplay是一个简单的播放器

ffmpeg基本的用法如下：

```bash
ffmpeg [options] [[infile options] -i infile]... {[outfile options] outfile}...
```

其中[options]用于指定ffmpeg全局选项，一般不用。[infile options]是针对输入视频文件指定某些参数（如跳过多长内容等），一般也不用。`-i infile`就是指定要转码的输入文件。[outfile options]指定输出文件的选项，主要就是通过这些输出文件选项来定义转码输出的具体格式，最后的outfile是输入文件名。

要注意的两点，一是输入文件的封装格式和编码格式都不用指定，ffmpeg会自动判断，主要是指定输出文件的详细参数来定制转码格式。二是输入文件参数和输出文件参数的位置要严格按照命令指示，输出参数必须是在`-i infile`之后及输出文件之前。

## 转码H.264/AAC

对于视频编码，有一个很重要的参数就是码率（单位是bps）表示每秒钟的文件大小（bit），在视频源、分辨率、帧率等都一致的情况下，高码率一般比地码率更加清晰，但是高码率带来的就是文件尺寸的增加（相同时长的视频，每秒的大小增加了，文件尺寸肯定也会增大）。在网上下载影视作品，同一部蓝光原盘转码且编码格式、分辨率等都一样的情况下，有些压制组释出的1080p电影会有几十GB，而有些的只有几GB大小，这之间的差异主要就是码率的不同。我们也能看出来，在播放器和显示设备都一样的前提下，同一部电影几十个G的文件观看起来会比几个G的文件质量高。

码率可以分为固定码率（CBR - Constant Bit Rate）和可变码率（VBR - Variable Bit Rate）。字面意思就可以理解，固定码率每秒钟的大小是固定，所以固定码率编码时知道视频文件的时长就能确定最终文件大小，而可变码率无法预测最终文件大小。可变码率在画面高速运动且画面色彩等变化较大时使用高码率，而在更多静态内容时使用低码率，这样在保证视频画面质量的同时，能尽可能减小视频文件体积。

先给出我常用的H.264转码的命令：

```bash
# 真人影视
ffmpeg -i <infile> -c:v libx264 -crf 23 -preset veryslow -tune film -c:a aac -strict -2 -b:a 128k <outfile>
# 动画片
ffmpeg -i <infile> -c:v libx264 -crf 25 -preset veryslow -tune animation -c:a aac -strict -2 -b:a 128k <outfile>
```

其中的参数解释如下：

- `-c:v libx264`：指定输出文件的视频采用x264编码。
- `-crf 23`：crf是x264的一种保证恒定质量的动态编码方式，这个是最简便的x264编码用法，但是其效果非常好。这个参数表示码率选用固定质量模式（一种动态编码方式），取值范围在0~51之间，0表示最高质量（无损编码），51表示最低质量（画面几乎都是马赛克）。一般取值在18~28之间即可，默认值23。
- `-preset veryslow`：权衡压缩效率和编码速度，如果对转换时间要求不多，尽量选择处理的慢点。默认值是medium，其他可接受值参见x264手册。
- `tune film`：调整选项，在preset之上进一步针对视频做最佳化，一般真人电影选择film，动画片可以选择animation，这个选项可以不用。
- `-c:a aac`：指定输出文件的音频采用aac编码。
- `-strict -2`：因为ffmpeg使用aac编码还处于实验性阶段，该参数强制ffmpeg可以使用实验性的aac编码。
- `-b:a 128k`：指定音频编码的平均码率为128kbps。
